---
title: 网络层
date: 2025-10-12 10:40:01
categories: cn
---

# IPv4与IPv6

- IPv4：
  - 地址长度：32位（4字节）
  - 表示方法：点分十进制
  - 地址空间：43亿个
- IPv6：
  - 地址长度：128位
  - 表示方法：冒分十六进制
  - 地址空间：非常大

# TTL机制

## 概念

- 全称：生存时间
- 作用：防止IP数据包在网络中无限循环地传输

## 工作机制

1. TTL是IP头中的一个字段，初始值通常为64,128或者255
2. 数据包每经过一个路由器，TTL减1
3. 当路由器将TTL减至0，会丢弃该数据包，并向IP地址发送一个ICMP超时消息

# 子网划分与CIDR

- **CIDR表示法**：无类别域间路由，用于更灵活地分配IP地址。格式为 `IP地址/前缀长度`，例如 `192.168.1.0/24`。
  - `/24` 表示网络部分占前24位，主机部分占后8位。
  - 可用IP地址数量为 2^8 - 2 = 254个（减去网络地址和广播地址）。
- **划分子网的目的**：
  1. **控制广播域**：缩小广播范围，减少网络中的广播流量（如ARP、DHCP广播），提高网络性能。
  2. **提高安全性**：便于在网络边界实施访问控制策略，例如限制不同子网间的访问。
  3. **IP地址高效利用**：根据实际需要分配地址空间，避免浪费。

# 路由机制

路由是网络层的核心功能，指路由器为数据包选择路径的过程。

- **静态路由**：由管理员手动配置路由表。适用于小型、结构稳定的网络。
- **动态路由协议**：路由器之间自动交换路由信息，动态更新路由表。
  - **RIP**：基于跳数的距离矢量协议，简单，适用于小型网络。
  - **OSPF**：基于链路状态的协议，收敛快，适用于大型企业网络。
  - **BGP**：路径矢量协议，用于在不同自治系统之间交换路由信息，是互联网的“骨架”协议。

# ICMP协议

- **全称**：互联网控制消息协议。
- **作用**：用于在IP主机、路由器之间传递**控制消息**，如网络通不通、主机是否可达、路由是否可用等。
- **常见应用**：
  - **Ping**：利用ICMP回送请求和回送应答消息，测试网络连通性。
  - **Traceroute**：利用ICMP超时消息和目的不可达消息，跟踪数据包路径。

# NAT

- **全称**：网络地址转换。
- **作用**：将私有IP地址转换为公有IP地址，使内网设备可以访问互联网。它有效缓解了IPv4地址短缺问题，并提供了一定的安全隐藏性。
- **基本过程**：NAT设备（通常是路由器）维护一个转换表。当内网主机发送数据包到外网时，NAT会将数据包的源IP和端口号替换为路由器的公网IP和一个新端口，并将映射关系记录在表中。当收到外网回复时，再根据转换表将目标IP和端口转换回内网主机的地址。

# IP分片

- **原因**：当IP数据包的大小超过数据链路层的**最大传输单元（MTU）** 时，就需要进行分片。
- **过程**：路由器将原始数据包分割成多个较小的**分片**，每个分片都拥有自己的IP头（包含分片相关信息）。这些分片独立传输到目的地后，由目的主机的IP层进行重组。
- **缺点**：
  - **性能开销**：每个分片都需要IP头，增加额外负担。
  - **可靠性差**：任何一个分片丢失，都会导致整个原始数据包重传。
- **优化**：因此，在传输层，TCP协议会通过**MSS（最大报文段长度）** 来主动限制 segment 的大小，从而**避免在IP层发生分片**。

# 面试经典题型

### **NAT的工作原理及其优缺点**

#### **参考回答**

**NAT**，即网络地址转换，是一种在当今互联网中至关重要的技术。它的核心功能是**将私有IP地址转换为公有IP地址**，使得使用私有地址的内网设备能够访问公共互联网。

**一、工作原理**

NAT通常运行在连接内网和外网的路由器（即NAT网关）上。其核心是一个**NAT转换表**，记录了内网IP和端口与外网IP和端口的映射关系。最常见的工作模式是**NAPT**，即同时转换IP地址和端口号。

其工作过程可以分为以下几步：

1. **出站请求（内网 -> 外网）**：

   - 当内网主机（例如 `192.168.1.100:5000`）想要访问外网服务器（例如 `203.0.113.1:80`）时，它会发送一个IP数据包。
   - 源IP：`192.168.1.100`，源端口：`5000`
   - 目标IP：`203.0.113.1`，目标端口：`80`
   - 这个数据包到达NAT路由器。
   - **NAT操作**：路由器会为该连接创建一个NAT表项。它将数据包的**源IP**替换为路由器自己的**公网IP**（例如 `198.51.100.1`），并分配一个新的**源端口**（例如 `10000`），然后将这个 `(公网IP:新端口, 目标IP:目标端口)` 的映射记录在NAT表中。
   - 修改后的数据包发出：源地址变为 `198.51.100.1:10000`，目标地址不变。

2. **NAT转换表记录**：

   - 路由器内部会生成一条类似这样的映射记录：

     | 内网本地地址 (Local) | 外网全局地址 (Global) | 外部服务器地址 (Remote) |
     | :------------------- | :-------------------- | :---------------------- |
     | `192.168.1.100:5000` | `198.51.100.1:10000`  | `203.0.113.1:80`        |

3. **入站响应（外网 -> 内网）**：

   - 外网服务器 `203.0.113.1:80` 收到请求后，会回复一个数据包。
   - 源IP：`203.0.113.1`，源端口：`80`
   - 目标IP：`198.51.100.1`，目标端口：`10000`（即N路由器转换后的地址）
   - 这个数据包到达NAT路由器。
   - **NAT操作**：路由器查看目标IP和端口 `198.51.100.1:10000`，并在NAT表中查找匹配的映射记录。
   - 找到记录后，路由器将数据包的**目标IP**还原为内网主机的 `192.168.1.100`，**目标端口**还原为 `5000`。
   - 然后将数据包转发给内网中的原始主机。

**简单比喻**：NAT就像一个公司的前台总机。公司内部有很多分机（私有IP），但对外只有一个总机号（公有IP）。外部电话打进来要找“小王”，前台需要查表知道“小王”对应的是“分机123”，然后把电话转接进去。

**二、优缺点**

**优点**：

1. **缓解IPv4地址枯竭**：这是NAT最重要的作用。一个家庭或企业只需要一个或少数几个公网IP，就可以让成百上千台设备同时上网。
2. **提供基础安全防护**：外部网络无法主动发起对NAT内部特定设备的连接，因为NAT表中没有对应的映射记录。这在一定程度上隐藏了内网拓扑，起到了类似防火墙的作用。
3. **网络部署灵活**：内网可以使用任意的私有地址空间，无需申请公网IP，便于网络规划和变更。

**缺点**：

1. **破坏了端到端通信原则**：这是NAT最大的理论缺陷。互联网设计初衷是任意两台主机都能直接通信，而NAT的介入使得通信必须经过地址转换，变得复杂。
2. **增加了延迟和复杂性**：每个数据包都需要经过修改和查表操作，增加了处理开销和延迟。
3. **导致某些应用兼容性问题**：对于一些复杂的网络协议（如IPsec、FTP的主动模式），它们会在应用层数据中携带IP地址信息，NAT设备无法识别和修改这些内容，导致连接失败。虽然可以通过ALG等技术解决，但增加了复杂性。
4. **对P2P应用不友好**：由于内网主机无法被外网直接访问，建立P2P连接（如视频通话、BT下载）需要借助STUN、TURN等中继服务器，过程复杂。
