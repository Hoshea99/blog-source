---
title: 传输层
date: 2025-10-12 10:57:32
categories: cn
---

# 概述

传输层位于网络层和应用层之间，为不同主机上的应用进程提供了逻辑通信功能

- 端口号

  唯一标识一台主机上的特定应用进程，16位整数

# UDP

## **特点**

- **无连接**：无需建立连接即可发送数据。
- **不可靠**：不保证数据交付、不保证顺序、不具备拥塞控制。
- **高效**：头部开销小，延迟低。

## 报文格式

UDP头部固定为**8字节**。

| 字段       | 长度 | 说明                             |
| :--------- | :--- | :------------------------------- |
| 源端口号   | 16位 | 发送方端口号（可省略为0）        |
| 目的端口号 | 16位 | 接收方端口号                     |
| 长度       | 16位 | UDP整个数据报（头部+数据）的长度 |
| 校验和     | 16位 | 用于差错检测（可选）             |

# TCP

TCP是面向连接的、可靠的、基于字节流的传输层通信协议。

## TCP报文格式

TCP头部**最小20字节**，最大60字节（因选项字段长度可变）。

**固定头部（20字节）**：

| 字段           | 长度 | 说明                                         |
| :------------- | :--- | :------------------------------------------- |
| 源端口号       | 16位 | 发送方端口号                                 |
| 目的端口号     | 16位 | 接收方端口号                                 |
| **序列号**     | 32位 | 本报文段所发送数据的第一个字节的序号         |
| **确认应答号** | 32位 | 期望收到的下一个报文段的第一个数据字节的序号 |
| **首部长度**   | 4位  | 以4字节为单位，指示TCP头部长度               |
| **保留位**     | 6位  | 保留为未来使用                               |
| **控制标志**   | 6位  | 见下表详解                                   |
| **窗口大小**   | 16位 | 用于流量控制，指示接收方还能接收的字节数     |
| **校验和**     | 16位 | 用于差错检测                                 |
| **紧急指针**   | 16位 | 当URG=1时有效，指示紧急数据的末尾            |

**控制标志（各占1位）**：

- **URG**：紧急指针有效。
- **ACK**：确认号有效。**一旦连接建立，该位通常始终为1**。
- **PSH**：接收方应尽快将数据交付应用层。
- **RST**：重置连接。
- **SYN**：同步序列号，用于**建立连接**。
- **FIN**：结束连接，用于**释放连接**。

**可选字段**：常见选项包括MSS（最大报文段长度）、窗口缩放因子、时间戳等。

## 序列号与确认应答机制

- **序列号**：标识发送数据流中每一个字节的编号。初始序列号随机生成，后续序列号按已发送的字节数递增。例如，发送seq=1000，数据长度为200，则下一个报文seq=1200。
- **确认应答号**：当ACK标志位为1时有效。它向发送方声明期望收到的下一个字节的序列号。例如，收到seq=1000，数据长度为150字节，则回复ack=1150。**确认应答号代表此序号之前的所有数据都已成功接收**。

# TCP连接管理

## 三次握手

用于建立TCP连接。

1. **第一次握手**：客户端发送SYN报文。随机生成初始序列号`client_isn`，并将SYN标志位置1。客户端进入`SYN-SENT`状态。
2. **第二次握手**：服务器收到SYN报文后，回复SYN-ACK报文。随机生成自己的初始序列号`server_isn`，将确认应答号设置为`client_isn + 1`，并将SYN和ACK标志位置1。服务器进入`SYN-RCVD`状态。
3. **第三次握手**：客户端收到SYN-ACK报文后，回复ACK报文。将确认应答号设置为`server_isn + 1`，ACK标志位置1。**此报文可以携带数据**。客户端进入`ESTABLISHED`状态，服务器收到后也进入`ESTABLISHED`状态。

**为什么需要三次握手？**

1. **阻止重复历史连接初始化（主因）**：防止旧的、延迟的SYN报文到达服务器，导致服务器错误地打开一个连接。客户端可以通过第三次握手来判断这是否是一个历史连接，并决定是否重置它。
2. **同步双方初始序列号**：确保双方都知晓并确认了对方的初始序列号，这是可靠传输的基础。
3. **避免资源浪费**：如果是两次握手，服务器收到SYN后就建立连接。若客户端的SYN报文丢失，服务器会一直维持一个无效的连接，造成资源浪费。

**相关概念**：

- **半连接队列**：服务器在收到第一次握手（SYN）后，但未完成三次握手时，会将连接请求放入此队列。
- **全连接队列**：已完成三次握手、建立成功的连接会被放入此队列，等待应用进程调用`accept()`取走。
- **SYN Flood攻击**：攻击者伪造大量IP发送SYN报文，但不完成第三次握手，占满服务器的半连接队列，导致正常用户无法连接。

## 四次挥手

用于释放TCP连接。TCP连接是全双工的，因此每个方向必须单独关闭。

1. **第一次挥手**：客户端打算关闭连接，发送一个FIN报文（FIN标志位置1）。客户端进入`FIN-WAIT-1`状态。
2. **第二次挥手**：服务器收到FIN报文后，回复一个ACK报文（确认应答号为客户端序列号+1）。服务器进入`CLOSE-WAIT`状态。此时，**从客户端到服务器的连接关闭，但服务器到客户端的连接仍然存在**（即半关闭状态）。
3. **第三次挥手**：当服务器处理完所有数据后，也发送一个FIN报文。服务器进入`LAST-ACK`状态。
4. **第四次挥手**：客户端收到服务器的FIN报文后，回复一个ACK报文。客户端进入`TIME-WAIT`状态。服务器收到ACK后，立即进入`CLOSED`状态。客户端经过**2MSL**（最长报文段寿命的两倍）时间后，也进入`CLOSED`状态。

**为什么需要四次挥手？**
因为TCP连接是全双工的，一方发送FIN只表示它不再发送数据，但还可以接收数据。服务器在收到客户端的FIN后，可能还有数据需要发送和处理，因此ACK和FIN报文需要分开发送，这就比三次握手多了一次。

**为什么需要TIME-WAIT状态？**

1. **可靠地终止连接**：确保最后一个ACK报文能够到达服务器。如果这个ACK丢失，服务器会超时重传FIN报文，处于`TIME-WAIT`状态的客户端可以重发ACK。
2. **让旧连接的所有报文在网络中消逝**：防止之前连接的延迟报文段被新的、具有相同四元组（源IP、源端口、目的IP、目的端口）的连接错误地接收。

# TCP可靠传输机制

## 重传机制

- **超时重传**：发送方为每个发送的数据包设置一个计时器。如果在**RTO**（超时重传时间）内未收到确认应答，就重传该数据包。RTO应略大于**RTT**（数据包的往返时间）。
- **快速重传**：当接收方收到一个失序的报文段时，它会立即重复发送最后一个按序接收的ACK。当发送方**连续收到3个重复的ACK**时，就认为该ACK之后的数据包已经丢失，会在超时之前立即重传，而不必等待超时。

## 滑动窗口与流量控制

- **目的**：解决发送方发送速率过快，导致接收方缓冲区溢出的问题。
- **机制**：
  - 接收方通过TCP头部的**窗口大小**字段，告知发送方自己接收缓冲区的剩余空间（接收窗口，`rwnd`）。
  - 发送方根据`rwnd`的大小，调整自己可以发送的数据量。
  - 当`rwnd = 0`时，发送方停止发送数据，并启动一个持久计时器，定期探测接收方窗口是否已恢复。

## 拥塞控制

- **目的**：防止过多的数据注入网络，避免网络中间设备（如路由器）负载过大。
- **核心**：发送方维护一个**拥塞窗口**，其大小取决于网络的拥塞程度。发送方的**实际发送窗口** = `min(拥塞窗口, 接收窗口)`。
- **四大算法**：
  1. **慢启动**：连接开始时，拥塞窗口从1开始，每收到一个ACK，窗口就加倍（指数增长）。直到窗口达到**慢启动阈值**。
  2. **拥塞避免**：当窗口达到慢启动阈值后，进入拥塞避免阶段，每收到一个ACK，窗口只增加1（线性增长）。
  3. **拥塞发生**：
     - **超时重传**：认为网络拥塞严重。慢启动阈值降为当前窗口的一半，拥塞窗口重置为1，重新开始慢启动。
     - **快速重传**（收到3个重复ACK）：认为网络拥塞较轻。执行**快速恢复**。
  4. **快速恢复**：
     - 慢启动阈值降为当前窗口的一半。
     - 拥塞窗口设置为新的慢启动阈值 + 3。
     - 重传丢失的数据包。
     - 每收到一个重复的ACK，拥塞窗口增加1。
     - 当收到一个新的数据的ACK时，退出快速恢复状态，进入拥塞避免阶段。
