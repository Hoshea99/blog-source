---
title: linux性能调优经验
date: 2025-10-13 15:35:22
categories: linux
---

# 多线程异步问题怎么解决?

锁、原子操作、条件变量、线程池。

muduo里的方法是：

1. one loop per thread 尽量减少跨线程通信
2. 线程安全的跨线程调用，用runInloop提交任务

# 发生内存泄漏时如何排查问题

1. gflags+umdh
2. 代码内循环
4. 共享内存泄露用查句柄泄露的方法排查

# CPU占用超过70%，如何排查？

1. 死循环或者低效算法
    比如增加休眠时间，优化算法
    while(!ready)一直在占用CPU，要改成条件变量
2. 多线程在锁上等待
    减小锁的粒度
3. IO太多
    比如日志等级太低，是否可以减少输出

# 性能调优经验案例

1. CPU调优

    perf火焰图显示热点在map.find
    改用unordered_map

2. 内存调优

    无内存泄漏但是内存碎片化严重
    对象复用

经验：
1. 先测量，再优化
2. 优先优化热点函数
3. 不要猜，用火焰图证明
4. 多个小优化会带来大优化
5. 优化完成需要回归测试

# 观测性能瓶颈时是什么资源问题

## 观测

vmstat 1指令 或者top也行

### CPU瓶颈判断：

| 监控指标         | 阈值条件         | 问题描述               |
|------------------|------------------|------------------------|
| `us + sy`        | > 0.8 (80%)      | CPU 资源紧张           |
| `wa`             | > 5%             | 存在 I/O 瓶颈          |
| `r` (运行队列长度) | > 2 * CPU 核数   | 进程排队等待 CPU       |

us：用户态进程占用CPU百分比

sy：内核态进程占用百分比

id：空闲百分比

wa：IO等待百分比

r：running 正在运行的进程数

### 内存不足信号

si>0或so>0  正在使用swap

si swap in

so swap out

原因解析：物理内存不足时，系统会将部分内存数据暂时移动到swap分区，导致性能下降，si>0或so>0导致正在频繁使用swap，是内存不足的明显信号

free持续下降 可能存在内存泄漏

cache很高但是应用慢 手动释放echo

### IO性能问题

wa高+bi/bo高

wa CPU等待IO完成的时间百分比
bi/bo每秒从块设备读取，写入的块数

b>0
不可中断睡眠状态的进程数（通常因为IO阻塞）

### 上下文切换过多

cs>10000/秒/核

上下文切换次数，即四核机器>40000就要注意了

## 解决

- 针对1：
    1. us高，通过top找到高CPU进程，优化算法、减少循环

    2. sy高，减少系统调用（高频文件读写改成批量操作）

    3. wa>5%，结合后面的IO部分处理

    4. r>2*CPU核数，扩容CPU资源，降低进程并发度

- 针对2：

    1. 情况1：si/so > 0（频繁使用Swap）

        **紧急处理：**

        释放缓存：echo 3 > /proc/sys/vm/drop_caches（临时方案）。

        终止非关键进程：kill -9 或 oom-killer 自动处理。

        **长期优化：**

        扩容物理内存。

        调整Swappiness：sysctl vm.swappiness=10（降低Swap倾向）。

        优化应用内存：检查内存泄漏（如 valgrind）、减少缓存大小。

    2. 情况2：free持续下降（内存泄漏）

        使用 pmap 或 jmap（Java）分析进程内存分布。

        监控工具：smem、valgrind 定位泄漏代码。

    3. 情况3：cache高但应用慢

        手动释放缓存（同上），或优化应用IO模式（如改用直接IO）。

- 针对3：

    1. wa高+bi/bo高

        iotop 查看进程级IO

        使用更快的存储（ssd）

        调整文件系统(ext4换成xfs)

        减少随机写

    2. 如果b>0

        检查磁盘健康，分散IO负载

- 针对4：

    1. 检查是否因为过多的线程或者频繁的锁竞争，优化代码，降低锁粒度。调整调度策略

# 内存泄漏一般什么场景会出现？

1. 未调用free或者malloc回收
2. 异常抛出后跳过清理代码
3. 共享内存的释放与申请和堆内存不一样，也是要释放的
